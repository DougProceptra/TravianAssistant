modules = ["nodejs-20", "python-3.11"]

# Main run command - starts the backend server
run = "cd backend && npm install && npm start"

# Deployment configuration
[deployment]
run = ["sh", "-c", "cd backend && npm start"]
deploymentTarget = "autoscale"
build = ["sh", "-c", "cd backend && npm install"]

# Environment variables for deployment
[env]
NODE_ENV = "production"
USE_SQLITE = "true"

[[ports]]
localPort = 3000
externalPort = 3000

[[ports]]
localPort = 3001
externalPort = 3001

[[ports]]
localPort = 3002
externalPort = 80

[[ports]]
localPort = 3003
externalPort = 3003

[[ports]]
localPort = 5000
externalPort = 5000

# Nix packages
[nix]
channel = "stable-25_05"
packages = ["nodejs-20", "nodePackages.npm", "nodePackages.pnpm", "lsof", "sqlite"]

# Workflows for different tasks
[workflows]
runButton = "Backend Server"

[[workflows.workflow]]
name = "Backend Server"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "Start Backend"

[[workflows.workflow]]
name = "Start Backend"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && npm install && npm start"
waitForPort = 3002

[[workflows.workflow]]
name = "Start Backend (SQLite)"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd backend && npm install && USE_SQLITE=true npm start"
waitForPort = 3002

[[workflows.workflow]]
name = "Build Extension"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pnpm install && pnpm build"

[[workflows.workflow]]
name = "Dev Extension"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pnpm install && pnpm dev"
waitForPort = 5000

# Language Server Protocol
[languages.javascript]
pattern = "**/*.{js,jsx}"

[languages.typescript]
pattern = "**/*.{ts,tsx}"

[languages.json]
pattern = "**/*.json"

# File visibility
[packager]
language = "nodejs"

[packager.features]
packageSearch = true
guessImports = true
enabledForHosting = true
